import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters,
    CallbackQueryHandler
)
from aiohttp import web
import asyncio

# –¢–≤–æ–π –≤–µ—Å—å –∏–º–ø–æ—Ä—Ç + —Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (log_to_sheet, build_human_friendly, –∏ —Ç.–¥.)
# –ü—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π –∏–∑ bot.py (–∏–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è —Å–µ–π—á–∞—Å –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è) ‚Äî –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω–∞–¥–æ.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  bot.py  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

# --- –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª credentials, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ---
if not os.path.exists("service_account.json"):
    creds = os.environ.get("GOOGLE_CREDENTIALS_JSON")
    if creds:
        with open("service_account.json", "w") as f:
            f.write(creds)
    else:
        raise RuntimeError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è GOOGLE_CREDENTIALS_JSON –Ω–µ –∑–∞–¥–∞–Ω–∞!")

import inspect, json, re, time
from functools import lru_cache
from itertools import groupby
import gspread
from google.oauth2.service_account import Credentials
import datetime
def log_to_sheet(user_id, username, message, bot_answer, timestamp):
    try:
        creds_json = os.environ.get("GOOGLE_CREDENTIALS_JSON")
        creds_dict = json.loads(creds_json)
        creds = Credentials.from_service_account_info(creds_dict, scopes=["https://www.googleapis.com/auth/spreadsheets"])
        gc = gspread.authorize(creds)
        sh = gc.open_by_key('11dG_R527d6toFdcgxtyyykxYjVZzodg05TLtQidDCHo')
        ws = sh.sheet1
        ws.append_row([str(user_id), username, message, bot_answer, timestamp])
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Google Sheets:", e)

try:
    from unidecode import unidecode
except ModuleNotFoundError:
    def unidecode(s: str) -> str:
        return s

import openai
from bs4 import BeautifulSoup
import numpy as np
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters,
)

if not hasattr(inspect, "getargspec"):
    inspect.getargspec = lambda f: inspect.getfullargspec(f)[:4]

from config_maps import UNIVERSAL_MAP
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

from dotenv import load_dotenv
load_dotenv()
OPENAI_API_KEY = os.environ.get("OPENAI_API_KEY")
TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

logging.basicConfig(
    format="%(asctime)s [%(levelname)s] %(name)s: %(message)s",
    level=logging.INFO
)
logger = logging.getLogger("rag-telegram-bot")
# user_id : (question, punkts, human_friendly, official_answer)
LAST_QA = {}

PUNKT_EMBS_PATH = "embeddings.npy"
PUNKT_JSON_PATH = "pravila_detailed_tagged_autofix.json"

PUNKT_EMBS = np.load(PUNKT_EMBS_PATH)
logger.info("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: %s", PUNKT_EMBS.shape)

def _sanitize(punkts):
    for p in punkts:
        for k in ("chapter","paragraph","punkt_num","subpunkt_num","list_item"):
            p[k] = str(p.get(k,"") or "")
        p["text"] = p["text"].replace("\\n","\n")
    return punkts

with open(PUNKT_JSON_PATH, encoding="utf-8") as f:
    PUNKTS = _sanitize(json.load(f))
logger.info("–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—É–Ω–∫—Ç–æ–≤: %d", len(PUNKTS))

TYPE_INDEX = {}
for p in PUNKTS:
    st = p.get("soft_type")
    if st:
        TYPE_INDEX.setdefault(st, []).append(p)

def clean_html(text: str) -> str:
    soup = BeautifulSoup(text, "html.parser")
    for tag in soup.find_all(True):
        if tag.name not in {"b","i","u","s","code","pre","small"}:
            tag.unwrap()
        else:
            tag.attrs = {}
    out = str(soup).replace("<br/>","\n").replace("<br>","\n")
    out = re.sub(r"<(\w+)>\s*</\1>", "", out)
    out = re.sub(r"\n{3,}", "\n\n", out)
    return out.strip()

def fix_unclosed_tags(html: str) -> str:
    for tag in ("b","i","u","s","code","pre","small"):
        diff = html.count(f"<{tag}>") - html.count(f"</{tag}>")
        if diff>0:
            html += f"</{tag}>" * diff
    return html

try:
    from spellchecker import SpellChecker
    SPELL = SpellChecker(language="ru")
    def autocorrect(txt: str) -> str:
        return " ".join(SPELL.correction(w) or w for w in txt.split())
except:
    autocorrect = lambda txt: txt

def blocks_commission(q: str):
    return [p for p in PUNKTS if "–ü—É–Ω–∫—Ç 20" in p["text"]][:3]

def blocks_appeal(q: str):
    if re.search(r"(–∞–ø–µ–ª–ª—è—Ü|–∂–∞–ª–æ–±)", q, re.I):
        return [p for p in PUNKTS if p["punkt_num"] in {"17","18"}][:5]
    return []

SOFT_RULES = {
    "violation": re.compile(r"\b(–Ω–∞—Ä—É—à|–∞–∫—Ç –Ω–∞—Ä—É—à|–∞–Ω–Ω—É–ª–∏—Ä|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å|–∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç—Å—è|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–æ|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å|–ø–æ–Ω–∏–∂–µ–Ω|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–æ—Ç–∫–ª–æ–Ω|–∂–∞–ª–æ–±|–∞–ø–µ–ª–ª—è—Ü|–∫–æ–º–∏—Å—Å–∏)\b", re.I),
    "notice": re.compile(r"\b(—É–≤–µ–¥–æ–º–ª–µ–Ω–∏|–æ—Ç–∫–∞–∑|—Ä–µ—à–µ–Ω–∏–µ|–∫–æ–º–∏—Å—Å–∏|–ø—Ä–æ—Ç–æ–∫–æ–ª|–ø—Ä–∏–∫–∞–∑)\b", re.I),
    "form": re.compile(r"\b(—Ñ–æ—Ä–º–∞|–∑–∞—è–≤–ª–µ–Ω–∏|–ø–µ—Ä–µ—á–µ–Ω—å|–ø—Ä–∏–ª–æ–∂–µ–Ω|–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ|–≤–µ–±-–ø–æ—Ä—Ç–∞–ª|–ø–ª–∞—Ç—Ñ–æ—Ä–º)\b", re.I),
}

UNIVERSAL_VIOLATION_PATTERN = re.compile(
    r"(–Ω–∞—Ä—É—à|–∞–∫—Ç|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|–∞–Ω–Ω—É–ª–∏—Ä|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞—Ç—å|–∞–Ω–Ω—É–ª–∏—Ä—É–µ—Ç—Å—è|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω|–∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–æ|–æ—Ç–∫–∞–∑|–æ—Ç—Å—Ç—Ä–∞–Ω|–¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|–ª–∏—à–µ–Ω|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–∑–∞–ø—Ä–µ—Ç|–≤–∑—ã—Å–∫–∞–Ω|–Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤|–Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω|—Å–∞–Ω–∫—Ü|–Ω–µ–¥–æ–ø—É—Å–∫|–æ—Ç–∫–ª–æ–Ω|–∂–∞–ª–æ–±|–∞–ø–µ–ª–ª—è—Ü|–ø—Ä–µ—Ç–µ–Ω–∑|–æ–±–∂–∞–ª|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω|–∫–æ–º–∏—Å—Å–∏|–ø–µ—Ä–µ—Å–º–æ—Ç—Ä|—Å–ø–æ—Ä–Ω|–Ω–µ—Å–æ–≥–ª–∞—Å|–æ—Ç–∑—ã–≤|–ø–æ–≤—Ç–æ—Ä–Ω|–ø—Ä–æ—Ç–æ–∫–æ–ª|–ø—Ä–∏–∫–∞–∑|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏|–∑–∞–∫–ª—é—á–µ–Ω|–ª–∏—Å—Ç|—Ä–µ—à–µ–Ω–∏|—Ñ–æ—Ä–º–∞|–ø—Ä–∏–ª–æ–∂–µ–Ω|–∑–∞—è–≤–ª–µ–Ω–∏|–≤—ã–ø–∏—Å–∫–∞|–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ|–≤–µ–±-–ø–æ—Ä—Ç–∞–ª|–ø–ª–∞—Ç—Ñ–æ—Ä–º)",
    re.I
)

SOFT_TYPES_KEYWORDS = {
    "portal": r"(–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ)",
    "defer": r"(–æ—Ç—Å—Ä–æ—á–∫|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–ø—Ä–æ–¥–ª–µ–Ω|–ø–µ—Ä–µ–Ω–æ—Å|—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ—Å–≤–æ–±–æ–∂–¥|—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–±–µ—Ä–µ–º–µ–Ω–Ω|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±|–±–æ–ª–µ–∑–Ω|–Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω|–ø–µ–Ω—Å–∏)"
}

def soft_blocks(question: str, limit_per_type: int = 8):
    rows = []

    # –û—Å–Ω–æ–≤–Ω—ã–µ soft‚Äëtype –≥—Ä—É–ø–ø—ã (–ø–æ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–µ)
    for stype, rx in SOFT_RULES.items():
        if rx.search(question):
            rows.extend(TYPE_INDEX.get(stype, [])[:limit_per_type])

    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–∞—Ä—É—à–µ–Ω–∏–π –∏ —Å–ø–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π
    if UNIVERSAL_VIOLATION_PATTERN.search(question):
        for p in PUNKTS:
            if UNIVERSAL_VIOLATION_PATTERN.search(p["text"]):
                if p not in rows:
                    rows.append(p)

    # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ–º: –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ ‚Äî> –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–æ–≤
    CRITICAL_BLOCKS = [
        # –ù–∞—Ä—É—à–µ–Ω–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
        (r"(–Ω–∞—Ä—É—à|–∞–∫—Ç –Ω–∞—Ä—É—à|–∞–Ω–Ω—É–ª–∏—Ä|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|–æ—Ç–∫–ª–æ–Ω|–¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|—Å–∞–Ω–∫—Ü|–æ—Ç–∫–∞–∑|–æ—Ç—Å—Ç—Ä–∞–Ω|–ª–∏—à–µ–Ω|–ø–æ–Ω–∏–∂–µ–Ω|–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω|–Ω–∞–∫–∞–∑–∞–Ω|–æ–±–Ω–∞—Ä—É–∂–µ–Ω)",
         ["10", "11", "12", "20"]),
        # –ê–ø–µ–ª–ª—è—Ü–∏–∏, –∂–∞–ª–æ–±—ã, –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏–µ, —Å–ø–æ—Ä—ã
        (r"(–∞–ø–µ–ª–ª—è—Ü|–∂–∞–ª–æ–±|–æ–±–∂–∞–ª|–ø—Ä–µ—Ç–µ–Ω–∑|—Å–ø–æ—Ä–Ω|–Ω–µ—Å–æ–≥–ª–∞—Å|–æ—Å–ø–æ—Ä|–ø–µ—Ä–µ—Å–º–æ—Ç—Ä|–∫–æ–º–∏—Å—Å–∏)", ["17", "18", "20"]),
        # –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –æ—Ç—Å—Ä–æ—á–∫–∞, –¥–µ–∫—Ä–µ—Ç, –ø–µ–Ω—Å–∏—è, –±–æ–ª–µ–∑–Ω–∏
        (r"(–æ—Ç—Å—Ä–æ—á–∫|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–ø—Ä–æ–¥–ª–µ–Ω|–ø–µ—Ä–µ–Ω–æ—Å|—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ—Å–≤–æ–±–æ–∂–¥|—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–±–µ—Ä–µ–º–µ–Ω–Ω|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±|–±–æ–ª–µ–∑–Ω|–Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω|–ø–µ–Ω—Å–∏|–≤–æ–∑—Ä–∞—Å—Ç|–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å|–Ω–µ –æ–±—è–∑–∞–Ω)",
         ["29", "30"]),
        # –ü—Ä–æ—Ç–æ–∫–æ–ª—ã, –∞–∫—Ç—ã, –≤—ã–ø–∏—Å–∫–∏, —Ä–µ—à–µ–Ω–∏—è –∫–æ–º–∏—Å—Å–∏–∏, –ø—Ä–∏–∫–∞–∑—ã, –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        (r"(–ø—Ä–æ—Ç–æ–∫–æ–ª|–∞–∫—Ç|–≤—ã–ø–∏—Å–∫–∞|—Ä–µ—à–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏|–ø—Ä–∏–∫–∞–∑|–∑–∞–∫–ª—é—á–µ–Ω–∏–µ|–ª–∏—Å—Ç|–∑–∞—Å–µ–¥–∞–Ω–∏–µ)", ["10", "11", "12", "13", "20"]),
        # –ó–∞—è–≤–ª–µ–Ω–∏—è, —Ñ–æ—Ä–º—ã, –ø–æ—Ä—Ç–∞–ª egov, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã
        (r"(–∑–∞—è–≤–ª–µ–Ω–∏|—Ñ–æ—Ä–º–∞|–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ|–≤–µ–±-–ø–æ—Ä—Ç–∞–ª|–ø—Ä–∏–ª–æ–∂–µ–Ω|–¥–æ–∫—É–º–µ–Ω—Ç|–ø–æ–¥–∞—á–∞|—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü)", ["15", "16"]),
        # –í–Ω–µ–æ—á–µ—Ä–µ–¥–Ω–∞—è/–¥–æ—Å—Ä–æ—á–Ω–∞—è/—É—Å–∫–æ—Ä–µ–Ω–Ω–∞—è/–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è
        (r"(–¥–æ—Å—Ä–æ—á–Ω|–≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω|—Å—Ä–æ—á–Ω|–ø–æ–≤—Ç–æ—Ä–Ω|—É—Å–∫–æ—Ä–µ–Ω|–Ω–µ–º–µ–¥–ª–µ–Ω–Ω|–Ω–µ–æ—Ç–ª–æ–∂–Ω)", ["31", "32"]),
        # –°—Ç–∞–∂–µ—Ä—ã, –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è
        (r"(—Å—Ç–∞–∂–µ—Ä|—Å—Ç–∞–∂—ë—Ä|–ø–µ—Ä–≤–∏—á–Ω|–ø–µ—Ä–≤—ã–π —Ä–∞–∑|–≤–ø–µ—Ä–≤—ã–µ|–æ–ø—ã—Ç|–∫–∞—Ç–µ–≥–æ—Ä)", ["23", "24", "25"]),
        # –ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–π, –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        (r"(–ø—Ä–∏—Å–≤–æ–µ–Ω|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω|–∏—Å–∫–ª—é—á–µ–Ω–∏|–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω|–æ—Ç–æ–∑–≤–∞–Ω|–∑–∞–º–µ–Ω–µ–Ω|–ø–æ—Ä—É—á–µ–Ω|—É—Ç–≤–µ—Ä–∂–¥–µ–Ω)", ["28", "29", "30"]),
    ]

    for pattern, punkt_nums in CRITICAL_BLOCKS:
        if re.search(pattern, question, re.I):
            for num in punkt_nums:
                for p in PUNKTS:
                    if p["punkt_num"] == num and p not in rows:
                        rows.append(p)

    # SPECIAL_PUNKTS –¥–ª—è —Ç–æ—á–µ—á–Ω—ã—Ö —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (–æ—Å—Ç–∞–ª–æ—Å—å –∏–∑ –≤–∞—à–µ–π –ª–æ–≥–∏–∫–∏)
    SPECIAL_PUNKTS = {
        "15": r"(–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç|–∑–∞—è–≤–∫|–∑–∞—è–≤–ª–µ–Ω|–ø–æ–¥–∞—Ç—å|–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ)",
        "29": r"(–æ—Ç—Å—Ä–æ—á–∫|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–ø—Ä–æ–¥–ª–µ–Ω|–ø–µ—Ä–µ–Ω–æ—Å|—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ—Å–≤–æ–±–æ–∂–¥|—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–±–µ—Ä–µ–º–µ–Ω–Ω|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±|–±–æ–ª–µ–∑–Ω|–Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω|–ø–µ–Ω—Å–∏)",
        "30": r"(–æ—Ç—Å—Ä–æ—á–∫|–æ—Å–≤–æ–±–æ–∂–¥|–ø–µ–Ω—Å–∏|–≤–æ–∑—Ä–∞—Å—Ç|–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ|–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å|–Ω–µ –æ–±—è–∑–∞–Ω)",
    }
    for punkt_num, regex in SPECIAL_PUNKTS.items():
        if re.search(regex, question, re.I):
            for p in PUNKTS:
                if p["punkt_num"] == punkt_num and p not in rows:
                    rows.insert(0, p)

    return rows


def unique(seq):
    seen, out = set(), []
    for p in seq:
        key = (p['chapter'],p['paragraph'],p['punkt_num'],p['subpunkt_num'])
        if key not in seen:
            seen.add(key); out.append(p)
    return out

def merge_bullets(rows):
    key = lambda x:(x['chapter'],x['paragraph'],x['punkt_num'],x['subpunkt_num'])
    merged = []
    for _, grp in groupby(sorted(rows, key=key), key):
        grp = list(grp)
        bullets = [g for g in grp
                   if g["text"].lstrip().startswith(("‚Äì","‚Äî","-"))
                   or g.get("list_item") in {"True","1","true"}]
        if len(bullets)>=2:
            merged.append({
                **{k:grp[0][k] for k in ('chapter','paragraph','punkt_num','subpunkt_num')},
                "text": "\n".join(g["text"] for g in grp)
            })
        else:
            merged.extend(grp)
    return merged

def _drop_headers(rows):
    return [p for p in rows if not p["text"].strip().endswith(":")]

def _boost_by_category(rows, question):
    if "—ç–∫—Å–ø–µ—Ä—Ç" not in question.lower():
        return rows
    boost, other = [], []
    for p in rows:
        cat = p.get("category") or []
        if isinstance(cat, str): cat = [cat]
        (boost if any("—ç–∫—Å–ø–µ—Ä—Ç" in c.lower() for c in cat) else other).append(p)
    return boost + other

def vector_search(question: str, top_k: int = 40):
    logger.info("‚û°Ô∏è vector_search: %s", question)
    emb = openai.embeddings.create(
        model="text-embedding-ada-002",
        input=question
    ).data[0].embedding
    qv = np.asarray(emb, dtype=np.float32)
    sims = (PUNKT_EMBS @ qv) / (
        np.linalg.norm(PUNKT_EMBS, axis=1) * np.linalg.norm(qv) + 1e-8
    )
    idx = np.argsort(-sims)[:top_k]
    return _boost_by_category([PUNKTS[i] for i in idx], question)

def bm25_fallback(question: str, k: int = 10):
    base = autocorrect(question.lower())
    toks = [t for t in re.findall(r"\w+", base) if len(t) > 3]
    scored = []
    for p in PUNKTS:
        scr = sum(tok in p["text"].lower() for tok in toks)
        if scr:
            scored.append((scr, p))
    return [p for _, p in sorted(scored, key=lambda x:-x[0])[:k]]
def add_all_violation_punkts(rows, question):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –≤ rows –≤—Å–µ –ø—É–Ω–∫—Ç—ã, –≥–¥–µ —è–≤–Ω–æ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –Ω–∞—Ä—É—à–µ–Ω–∏—è/—Å–∞–Ω–∫—Ü–∏–∏/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å,
    –µ—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –µ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–ª–æ–≤–∞.
    """
    VIOLATION_RX = re.compile(
        r"(–Ω–∞—Ä—É—à|–∞–∫—Ç|–∞–Ω–Ω—É–ª–∏—Ä|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|—Å–∞–Ω–∫—Ü|–æ—Ç–∫–∞–∑|–æ—Ç—Å—Ç—Ä–∞–Ω|–¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω|–Ω–∞–∫–∞–∑–∞–Ω|–æ–±–Ω–∞—Ä—É–∂–µ–Ω|–æ—Ç–∫–ª–æ–Ω|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|–ª–∏—à–µ–Ω|–ø–æ–Ω–∏–∂–µ–Ω|–Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω)",
        re.I
    )
    if VIOLATION_RX.search(question):
        for p in PUNKTS:
            if VIOLATION_RX.search(p["text"]):
                if p not in rows:
                    rows.append(p)
    return rows

@lru_cache(maxsize=256)
def rag_search(question: str, k: int = 60):
    mapped = []
    q_lower = question.lower()
    for kword, v in UNIVERSAL_MAP.items():
        if kword in q_lower:
            mapped += [p for p in PUNKTS if p["punkt_num"] == v["punkt_num"]
                       and (v["subpunkt_num"] == "" or p["subpunkt_num"] == v["subpunkt_num"])]

    # –≠–º–±–µ–¥–¥–∏–Ω–≥-–ø–æ–∏—Å–∫ (—á–µ—Ä–µ–∑ OpenAI, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω)
    try:
        emb = openai.embeddings.create(
            model="text-embedding-ada-002",
            input=question
        ).data[0].embedding
        qv = np.asarray(emb, dtype=np.float32)
        sims = (PUNKT_EMBS @ qv) / (np.linalg.norm(PUNKT_EMBS, axis=1) * np.linalg.norm(qv) + 1e-8)
        idx = np.argsort(-sims)[:40]
        semant = [PUNKTS[i] for i in idx]
    except Exception:
        semant = []

    # Regex/keyword-–ø–æ–∏—Å–∫
    keywords = set(re.findall(r'\w+', q_lower))
    regexed = []
    for word in keywords:
        if len(word) >= 4:
            regexed += [p for p in PUNKTS if word in p["text"].lower()]
    # Trigger-based (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –≤–∞–∂–Ω—ã–µ –ø—É–Ω–∫—Ç—ã)
    trigger_nums = []
    if re.search(r"–Ω–∞—Ä—É—à|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|–∞–Ω–Ω—É–ª–∏—Ä|–∞–∫—Ç|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω", q_lower):
        trigger_nums += ["45", "46", "47", "62"]
    if re.search(r"–ø–µ–Ω—Å–∏|–≤–æ–∑—Ä–∞—Å—Ç|–ø–µ–Ω—Å–∏–æ–Ω|–æ—Å–≤–æ–±–æ–∂–¥|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–±–µ—Ä–µ–º–µ–Ω–Ω|–¥–µ–∫—Ä–µ—Ç", q_lower):
        trigger_nums += ["29", "30"]
    if re.search(r"–±–æ–ª–∞—à–∞|nazarbayev|phd|—Å—Ç–µ–ø–µ–Ω—å|–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç|–º–∞–≥–∏—Å—Ç—Ä", q_lower):
        trigger_nums += ["32"]
    if re.search(r"–∞–ø–µ–ª–ª—è—Ü|–∂–∞–ª–æ–±|–æ–±–∂–∞–ª|—Å–ø–æ—Ä–Ω|–ø–µ—Ä–µ—Å–º–æ—Ç—Ä|–∫–æ–º–∏—Å—Å–∏", q_lower):
        trigger_nums += ["17", "18", "20"]
    triggers = [p for p in PUNKTS if p["punkt_num"] in trigger_nums]

    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å—ë –≤ rows
    rows = []
    seen = set()
    for l in (mapped, semant, regexed, triggers):
        for p in l:
            key = (p["punkt_num"], p["subpunkt_num"])
            if key not in seen:
                rows.append(p)
                seen.add(key)

    # --- –î–û–ë–ê–í–õ–Ø–ï–ú soft_blocks –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è ---
    rows += soft_blocks(question)

    # Fallback –µ—Å–ª–∏ –≤—Å—ë –ø—É—Å—Ç–æ
    if not rows:
        rows = bm25_fallback(question, 10)

    # –û—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à–∏ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã!
    rows = unique(rows)
    rows = merge_bullets(rows)
    rows = _drop_headers(rows)
    rows = add_all_violation_punkts(rows, question)
    rows = unique(rows)
    print("RAG SELECTED:", [(p["punkt_num"], p["text"][:70]) for p in rows[:k]])
    return rows[:k]


def build_prompt(q, punkts):
    context = "\n\n".join(
        f"{i+1}. [{p['punkt_num']}{('/'+p['subpunkt_num']) if p['subpunkt_num'] else ''}]\n{p['text']}"
        for i, p in enumerate(punkts)
    )

    addendum = ""

    # 1. –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–ª–µ–Ω–∏–π/–ø–æ—Ä—Ç–∞–ª/–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if re.search(r"(–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç|–∑–∞—è–≤–∫|–∑–∞—è–≤–ª–µ–Ω|–ø–æ–¥–∞—Ç—å|–∫–∞—Ç–µ–≥–æ—Ä|–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –ø—É–Ω–∫—Ç –ø—Ä–æ –ø–æ–¥–∞—á—É –∑–∞—è–≤–∫–∏ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —á–µ—Ä–µ–∑ –≤–µ–±-–ø–æ—Ä—Ç–∞–ª —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞, "
            "–≤ —Ä–∞–∑–¥–µ–ª–µ <b>1. –†–µ–∑—é–º–µ:</b> –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ –ø—Ä–æ –≤–µ–±-–ø–æ—Ä—Ç–∞–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´egov.kz¬ª) —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–æ–º–µ—Ä–∞ –ø—É–Ω–∫—Ç–∞."
        )

    # 2. –í–æ–∑—Ä–∞—Å—Ç/–ø–µ–Ω—Å–∏—è/–¥–æ —Å–∫–æ–ª—å–∫–∏ –ª–µ—Ç
    if re.search(r"(–¥–æ —Å–∫–æ–ª—å–∫|–≤–æ–∑—Ä–∞—Å—Ç|–ø–µ–Ω—Å–∏|–ª–µ—Ç|years|—Å—Ç–∞—Ä—à–µ|–ø–µ–Ω—Å–∏–æ–Ω–Ω|–≤–æ–∑—Ä–∞—Å—Ç–Ω|–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –ø—É–Ω–∫—Ç—ã –ø—Ä–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ—Ç –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –∏–ª–∏ –ø–µ–Ω—Å–∏–∏, "
            "–∏–ª–∏ –ø—Ä–æ –ø–æ—Ä—è–¥–æ–∫ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –Ω–∞ –ø–µ–Ω—Å–∏—é, –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –∏—Ö —Å –Ω–æ–º–µ—Ä–∞–º–∏ –ø—É–Ω–∫—Ç–æ–≤ –≤ <b>1. –†–µ–∑—é–º–µ:</b>. "
            "–Ø—Å–Ω–æ —É–∫–∞–∂–∏, –¥–æ –∫–∞–∫–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –∏ –∫–∞–∫ –æ–Ω–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ–Ω—Å–∏–∏."
        )

    # 3. –û—Ç—Å—Ä–æ—á–∫–∞/–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞/–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ/–ø–µ—Ä–µ–Ω–æ—Å/–±–æ–ª–µ–∑–Ω—å/–¥–µ–∫—Ä–µ—Ç –∏ —Ç.–¥.
    if re.search(r"(–æ—Ç—Å—Ä–æ—á–∫|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–ø—Ä–æ–¥–ª–µ–Ω|–ø–µ—Ä–µ–Ω–æ—Å|—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ—Å–≤–æ–±–æ–∂–¥|–∏—Å–∫–ª—é—á–µ–Ω|–ø–µ—Ä–µ—Ä—ã–≤|–ø—Ä–µ–∫—Ä–∞—â–µ–Ω|–ø–∞—É–∑–∞|–Ω–µ –ø—Ä–æ—Ö–æ–¥|–Ω–µ –æ–±—è–∑|–≤—ã—Ö–æ–¥ –Ω–∞ –ø–µ–Ω—Å–∏|–±–µ—Ä–µ–º–µ–Ω–Ω|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±|–±–æ–ª–µ–∑–Ω|–Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –µ—Å—Ç—å –ø—É–Ω–∫—Ç—ã –æ–± –æ—Ç—Å—Ä–æ—á–∫–µ, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏, –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –∏—Ö –¥–æ—Å–ª–æ–≤–Ω–æ –≤ <b>1. –†–µ–∑—é–º–µ:</b> —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É–Ω–∫—Ç–æ–≤. "
            "–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à–∏ —É—Å–ª–æ–≤–∏—è, –ø–æ—Ä—è–¥–æ–∫ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ —Å–ª—É—á–∞—è."
        )

    # 4. –ü–µ—Ä–≤–∏—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è/—Å—Ç–∞–∂—ë—Ä/–ø–µ—Ä–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è/–≤–ø–µ—Ä–≤—ã–µ
    if re.search(r"(—Å—Ç–∞–∂–µ—Ä|—Å—Ç–∞–∂—ë—Ä|–ø–µ—Ä–≤–∏—á–Ω|–ø–µ—Ä–≤—ã–π —Ä–∞–∑|–≤–ø–µ—Ä–≤—ã–µ|–Ω–∞—á–∞–ª|–ø–µ—Ä–≤–∞—è|—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª|–ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≥–æ–¥–∞|–ø–æ—Å–ª–µ –≥–æ–¥–∞|—Å—Ç–∞–∂ —Ä–∞–±–æ—Ç—ã)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´–ø–µ–¥–∞–≥–æ–≥¬ª –ø–æ—Å–ª–µ —Å—Ç–∞—Ç—É—Å–∞ ¬´–ø–µ–¥–∞–≥–æ–≥-—Å—Ç–∞–∂–µ—Ä¬ª, –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π, —á—Ç–æ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≥–æ–¥–∞ –ø–æ–¥–∞–µ—Ç—Å—è –∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´–ø–µ–¥–∞–≥–æ–≥¬ª –±–µ–∑ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ (—Å –Ω–æ–º–µ—Ä–æ–º –ø—É–Ω–∫—Ç–∞). "
            "–ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ä–æ–∫–∏ –ø–µ—Ä–≤–æ–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ ‚Äî –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –∏—Ö –≤ <b>1. –†–µ–∑—é–º–µ:</b> –∏ –ø—Ä–∏–≤–µ–¥–∏ –ø–æ—à–∞–≥–æ–≤–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—É."
        )

    # 5. –ê–ø–µ–ª–ª—è—Ü–∏—è/–∂–∞–ª–æ–±–∞/–æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ/—Å–ø–æ—Ä–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏
    if re.search(r"(–∞–ø–µ–ª–ª—è—Ü|–∂–∞–ª–æ–±|–æ–±–∂–∞–ª|–ø—Ä–µ—Ç–µ–Ω–∑|—Å–ø–æ—Ä–Ω|–Ω–µ—Å–æ–≥–ª–∞—Å|–æ—Å–ø–æ—Ä|–ø–µ—Ä–µ—Å–º–æ—Ç—Ä|–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è|–∫–æ–º–∏—Å—Å–∏|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –ø—É–Ω–∫—Ç—ã –æ –∂–∞–ª–æ–±–µ, –∞–ø–µ–ª–ª—è—Ü–∏–∏ –∏–ª–∏ —Å–ø–æ—Ä–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö ‚Äî –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –¥–æ—Å–ª–æ–≤–Ω–æ –∫—É–¥–∞, –∫–æ–≥–¥–∞ –∏ –∫–∞–∫ –ø–æ–¥–∞–µ—Ç—Å—è –∂–∞–ª–æ–±–∞ –∏–ª–∏ –∞–ø–µ–ª–ª—è—Ü–∏—è (—Å —Ç–æ—á–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –ø—É–Ω–∫—Ç–∞–º–∏). "
            "–í —Ä–∞–∑–¥–µ–ª–∞—Ö ¬´–ü–æ—Ä—è–¥–æ–∫¬ª –∏ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª –ø–æ—à–∞–≥–æ–≤–æ –æ–ø–∏—à–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∏ —Å—Ä–æ–∫–∏, –µ—Å–ª–∏ —Ç–∞–∫–∏–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã."
        )

    # 6. –ù–∞—Ä—É—à–µ–Ω–∏—è/–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞/—Å–∞–Ω–∫—Ü–∏–∏/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å/–æ—Ç–∫–∞–∑
    if re.search(r"(–Ω–∞—Ä—É—à|–∞–∫—Ç –Ω–∞—Ä—É—à|–∞–Ω–Ω—É–ª–∏—Ä|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|–æ—Ç–∫–ª–æ–Ω|–¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|–æ—Ç–∫–∞–∑|–æ—Ç—Å—Ç—Ä–∞–Ω|—Å–∞–Ω–∫—Ü|–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω|–ª–∏—à–µ–Ω|–ø–æ–Ω–∏–∂–µ–Ω|–Ω–∞–∫–∞–∑–∞–Ω|–Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω|–æ–±–Ω–∞—Ä—É–∂–µ–Ω)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö, –∞–∫—Ç–∞—Ö –Ω–∞—Ä—É—à–µ–Ω–∏—è, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö –∏–ª–∏ —Å–∞–Ω–∫—Ü–∏—è—Ö, –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π —ç—Ç–∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É–Ω–∫—Ç–∞. "
            "–í —Ä–∞–∑–¥–µ–ª–∞—Ö ¬´–û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏¬ª –∏ ¬´–ü–æ—Ä—è–¥–æ–∫¬ª –æ–ø–∏—à–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —à–∞–≥–∏."
        )

    # 7. –î–æ–∫—É–º–µ–Ω—Ç—ã/—Ñ–æ—Ä–º—ã/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è/–ø—Ä–æ—Ç–æ–∫–æ–ª—ã
    if re.search(r"(–¥–æ–∫—É–º–µ–Ω—Ç|—Ñ–æ—Ä–º–∞|–ø—Ä–∏–ª–æ–∂–µ–Ω|–∑–∞—è–≤–ª–µ–Ω–∏|–ø–µ—Ä–µ—á–µ–Ω—å|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏|—Ä–µ—à–µ–Ω–∏|–ø—Ä–æ—Ç–æ–∫–æ–ª|–ø—Ä–∏–∫–∞–∑|–ª–∏—Å—Ç|–≤—ã–ø–∏—Å–∫–∞)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å —Ñ–æ—Ä–º—ã –∑–∞—è–≤–ª–µ–Ω–∏–π, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –∏–ª–∏ –ø—Ä–∏–∫–∞–∑–æ–≤, –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏—Ö –≤—Å–µ —Å —Ç–æ—á–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –Ω–æ–º–µ—Ä–∞–º–∏ –ø—É–Ω–∫—Ç–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ <b>3. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è:</b>."
        )

    # 8. –í–Ω–µ–æ—á–µ—Ä–µ–¥–Ω–∞—è/–¥–æ—Å—Ä–æ—á–Ω–∞—è/—É—Å–∫–æ—Ä–µ–Ω–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è
    if re.search(r"(–¥–æ—Å—Ä–æ—á–Ω|–≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω|—Å—Ä–æ—á–Ω|—É—Å–∫–æ—Ä–µ–Ω|–Ω–µ–º–µ–¥–ª–µ–Ω–Ω|–Ω–µ–æ—Ç–ª–æ–∂–Ω)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω–æ–π –∏–ª–∏ –¥–æ—Å—Ä–æ—á–Ω–æ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ ‚Äî –≤ —Ä–∞–∑–¥–µ–ª–µ <b>1. –†–µ–∑—é–º–µ:</b> –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É —Å –Ω–æ–º–µ—Ä–æ–º –ø—É–Ω–∫—Ç–∞. "
            "–í —Ä–∞–∑–¥–µ–ª–∞—Ö ¬´–ü–æ—Ä—è–¥–æ–∫¬ª –∏ ¬´–î–æ–∫—É–º–µ–Ω—Ç—ã¬ª –æ–ø–∏—à–∏ –≤—Å—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è."
        )

    # 9. –ü—Ä–æ—á–∏–µ —Å–º–µ—à–∞–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞)
    if re.search(r"(–æ—Ü–µ–Ω–∫|—Å—Ç–∞–∂|–∫–∞—Ç–µ–≥–æ—Ä|–∫–æ–º–∏—Å—Å–∏|–æ–±–æ–±—â|—Ä–µ–∑—É–ª—å—Ç–∞—Ç|–ø—Ä–æ—Ü–µ–¥—É—Ä|—Ä–µ—à–µ–Ω–∏|–ø—Ä–∏–∫–∞–∑|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω|–ø–æ–≤—ã—à–µ–Ω|–ø—Ä–æ—Ö–æ–∂–¥|–ø—Ä–∏—Å–≤–æ–µ–Ω|–æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω|–Ω–∞–∑–Ω–∞—á–µ–Ω|–Ω–∞–∑–Ω–∞—á–µ–Ω–∏|–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω|–æ—Ç–æ–∑–≤–∞–Ω|–∑–∞–º–µ–Ω–µ–Ω|–ø–æ—Ä—É—á–µ–Ω|—É—Ç–≤–µ—Ä–∂–¥–µ–Ω)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ —Å—Ä–µ–¥–∏ –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å –ª—é–±—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è, –∫–æ–º–∏—Å—Å–∏–π, –∏—Ç–æ–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –∏–ª–∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π —ç—Ç–∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É–Ω–∫—Ç–æ–≤."
        )
        # –ù–æ–≤—ã–π –±–ª–æ–∫: –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π, —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –æ—Å–Ω–æ–≤–∞–Ω–∏—è–º–∏ (–ø–µ–Ω—Å–∏—è+–¥–µ–∫—Ä–µ—Ç+–≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω–∞—è –∏ –ø—Ä.)
    if re.search(r"(–≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω|–¥–æ—Å—Ä–æ—á–Ω|—Å—Ä–æ—á–Ω|–ø–æ–≤—Ç–æ—Ä–Ω|–ø–µ–Ω—Å–∏|–¥–µ–∫—Ä–µ—Ç|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–±–µ—Ä–µ–º–µ–Ω–Ω|–∫–æ–º–∏—Å—Å–∏)", q, re.I):
        addendum += (
            "\n\n–ï—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –∏–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ–Ω—Å–∏—è –∏ –¥–µ–∫—Ä–µ—Ç, –¥–µ–∫—Ä–µ—Ç –∏ –≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä), –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª—É—á–∞—è –æ—Ç–¥–µ–ª—å–Ω–æ. " 
            "–ï—Å–ª–∏ —á–∞—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —è–≤–Ω–æ –Ω–∞–ø–∏—à–∏ –æ–± —ç—Ç–æ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º —Ä–∞–∑–¥–µ–ª–µ."
        )
    # 10. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ–ª–±—ç–∫ ‚Äî –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—Å–ø–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ–Ω—Å–∏—è –∏ —Å—Ç–∞–∂, –∂–∞–ª–æ–±–∞ –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∏ —Ç.–¥.)
    addendum += (
        "\n\n–ï—Å–ª–∏ –≤ –≤–æ–ø—Ä–æ—Å–µ –∏–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ–Ω—Å–∏—è –∏ —Å—Ç–∞–∂, —Å—Ç–∞–∂—ë—Ä –∏ –¥–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏ –∂–∞–ª–æ–±–∞), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∏ –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –∫–∞–∂–¥—ã–π –∞—Å–ø–µ–∫—Ç –∏ –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è —Å —Ç–æ—á–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ –∏ –ø—É–Ω–∫—Ç–∞–º–∏ ‚Äî –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –æ—Ç–≤–µ—Ç–∞."
    )

    system = (
        "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ü—Ä–∞–≤–∏–ª–∞–º –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –ø–µ–¥–∞–≥–æ–≥–æ–≤ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω.\n"
        "–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.\n\n"
        "–°—Ç–∏–ª—å –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:\n"
        "‚Äì –û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π, –±–µ–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏–ª–∏ —É–ø—Ä–æ—â–µ–Ω–∏–π.\n"
        "‚Äì –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏, –ø–µ—Ä–µ—Å–∫–∞–∑—ã –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è.\n"
        "‚Äì –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–æ–¥–µ ¬´–ø—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è¬ª, ¬´—ç—Ç–æ –∑–Ω–∞—á–∏—Ç¬ª, ¬´–∏–Ω–∞—á–µ –≥–æ–≤–æ—Ä—è¬ª.\n"
        "‚Äì –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö –Ω–µ—Ç, —è–≤–Ω–æ –Ω–∞–ø–∏—à–∏: ¬´–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–∞–ø—Ä—è–º—É—é –æ—Ç–≤–µ—á–∞—é—â–∞—è –Ω–∞ –¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å.¬ª\n\n"
        "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n"
        "<b>1. –†–µ–∑—é–º–µ:</b> –æ–¥–Ω–∞ —Ñ—Ä–∞–∑–∞ ‚Äî —Å—Ç—Ä–æ–≥–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–ª–∏ –∏—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É–Ω–∫—Ç–∞. "
        "–ï—Å–ª–∏ –µ—Å—Ç—å —Å–ª—É—á–∞–∏ –æ—Ç—Å—Ä–æ—á–∫–∏, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è, –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –æ—Å–æ–±—ã–µ –ø—Ä–∞–≤–∏–ª–∞, –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –∂–∞–ª–æ–±—ã –∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è ‚Äî –ø—Ä–æ—Ü–∏—Ç–∏—Ä—É–π –∏—Ö —Å –Ω–æ–º–µ—Ä–∞–º–∏ –ø—É–Ω–∫—Ç–æ–≤.\n\n"
        "<b>2. –û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è/–∫—Ä–∏—Ç–µ—Ä–∏–∏:</b>\n"
        "‚Äì –ò—Å–ø–æ–ª—å–∑—É–π –¥–æ—Å–ª–æ–≤–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –∏ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤ (—Å—Å—ã–ª–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞: –ø. X –ø–æ–¥–ø. Y).\n"
        "‚Äì –°—Ç—Ä–æ–≥–æ –±–µ–∑ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ –æ–±–æ–±—â–µ–Ω–∏–π.\n\n"
        "<b>3. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è:</b>\n"
        "‚Äì –î–æ—Å–ª–æ–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å —Ç–æ—á–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ê–∫—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∏ —É—Å–ª–æ–≤–∏–π –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ –∑–Ω–∞–Ω–∏–π –ø–µ–¥–∞–≥–æ–≥–∞ (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 10 –∫ –ü—Ä–∞–≤–∏–ª–∞–º)¬ª). "
        "–í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π –Ω–æ–º–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø—É–Ω–∫—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–∞–ø–∏—à–∏ —ç—Ç–æ —è–≤–Ω–æ.\n\n"
        "<b>4. –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã / —ç—Ç–∞–ø—ã:</b>\n"
        "‚Äì –¢–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø—É–Ω–∫—Ç–æ–≤.\n"
        "‚Äì –ù–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –∏ –Ω–µ –¥–æ–±–∞–≤–ª—è–π —à–∞–≥–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ.\n\n"
        "<b>5. –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ / –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å):</b>\n"
        "‚Äì –î–æ—Å–ª–æ–≤–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã –æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π, –æ—Ç–∫–∞–∑–∞—Ö, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É–Ω–∫—Ç–∞. "
        "–í–∫–ª—é—á–∏ –≤—Å–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –æ—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ–ª–µ–∑–Ω—å, –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å, –ø–µ–Ω—Å–∏—è, —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –∞–ø–µ–ª–ª—è—Ü–∏—è, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è, –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –∏ –¥—Ä.), —Å –¥–æ—Å–ª–æ–≤–Ω–æ–π —Ü–∏—Ç–∞—Ç–æ–π –∏ –Ω–æ–º–µ—Ä–æ–º –ø—É–Ω–∫—Ç–∞.\n\n"
        "<b>6. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:</b>\n"
        "‚Äì –í–∫–ª—é—á–∞–π –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –±—ã–ª–∏ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ—Ç–≤–µ—Ç–µ, –Ω–æ –∏–º–µ—é—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –≤–æ–ø—Ä–æ—Å—É.\n"
        "‚Äì –ü–µ—Ä–µ—á–∏—Å–ª—è–π –∫—Ä–∞—Ç–∫–æ –∏ —á—ë—Ç–∫–æ, —É–∫–∞–∑—ã–≤–∞—è –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.\n"
        "‚Äì –ù–µ –¥—É–±–ª–∏—Ä—É–π —É–∂–µ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã.\n\n"
        "–ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:\n"
        "‚Äì –ò—Å–ø–æ–ª—å–∑—É–π HTML-—Ç–µ–≥–∏ <b>...</b> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤.\n"
        "‚Äì –ß—ë—Ç–∫–æ —Ä–∞–∑–¥–µ–ª—è–π –∞–±–∑–∞—Ü—ã.\n"
        "‚Äì –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–æ–≤ –Ω–∞—á–∏–Ω–∞–π —Å ¬´‚Äì ¬ª.\n\n"
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:\n"
        "‚Äì –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞—ë—Ç —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å, –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–≤–æ–¥–∏ —Ç–æ—á–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã.\n"
        "‚Äì –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤–Ω–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤."
        + addendum
    )

    user = f"–í–æ–ø—Ä–æ—Å: ¬´{q}¬ª\n\n–§—Ä–∞–≥–º–µ–Ω—Ç—ã:\n{context}\n\n–û—Ç–≤–µ—Ç:"
    return [{"role": "system", "content": system}, {"role": "user", "content": user}]

def ask_llm(q, punkts):
    for attempt in range(3):
        try:
            r = openai.chat.completions.create(
                model="gpt-4o-mini",
                messages=build_prompt(q, punkts),
                temperature=0.2,
                max_tokens=2000,
            )
            return clean_html(r.choices[0].message.content.strip())
        except openai.RateLimitError:
            time.sleep(2**attempt)
        except openai.OpenAIError as e:
            logger.error("OpenAIError: %s", e)
            break
    sample = "\n".join(f"‚Ä¢ {p['text']}" for p in punkts[:5])
    return f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç LLM.\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã:\n{sample}"

def postprocess_answer(q, punkts, answer):
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–ª—è –æ—Ç–≤–µ—Ç–∞:
    # ‚Äì –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏ –ø—É–Ω–∫—Ç–æ–≤/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏.
    # ‚Äì –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Å–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ "–î–æ–∫—É–º–µ–Ω—Ç—ã".
    # ‚Äì –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/–ø—É—Å—Ç–æ–π ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...'
    # ‚Äì –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –Ω–æ–º–µ—Ä–∞.

    all_punkt_nums = set(p["punkt_num"] for p in punkts if p["punkt_num"])
    all_apps = set(re.findall(r"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\s?\d+", "\n".join([p["text"] for p in punkts])))

    cited_nums = set(re.findall(r"–ø\. ?(\d+[\w\.]*)", answer))
    cited_apps = set(re.findall(r"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\s?\d+", answer))

    missed_apps = all_apps - cited_apps
    if missed_apps:
        docs_block = "\n" + "\n".join([f"‚Äì {app} (—Å–º. —Ç–µ–∫—Å—Ç –ü—Ä–∞–≤–∏–ª)" for app in sorted(missed_apps)]) + "\n"
        answer = re.sub(
            r"(<b>3\. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è:</b>[\s\S]*?)(?=<b>|$)",
            lambda m: m.group(1) + docs_block,
            answer,
        )

    for sec in [
        "1. –†–µ–∑—é–º–µ",
        "2. –û—Å–Ω–æ–≤–Ω—ã–µ —É—Å–ª–æ–≤–∏—è/–∫—Ä–∏—Ç–µ—Ä–∏–∏",
        "3. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è",
        "4. –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã / —ç—Ç–∞–ø—ã",
        "5. –û—Å–æ–±—ã–µ —Å–ª—É—á–∞–∏ / –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)",
        "6. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã",
    ]:
        if f"<b>{sec}:</b>" not in answer:
            answer += f"\n\n<b>{sec}:</b>\n–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É —Ä–∞–∑–¥–µ–ª—É."

    # –ù–û–í–´–ô –ë–õ–û–ö: –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ "–°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã"
    related = filter_related_punkts(q, punkts, cited_nums)
    if related:
        related_block = "<b>6. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:</b>\n" + "\n".join(
            f"‚Äì –ü—É–Ω–∫—Ç {p['punkt_num']}: {p['text'].split('.')[0][:80]}..." for p in related
        )
    else:
        related_block = "<b>6. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:</b>\n–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É —Ä–∞–∑–¥–µ–ª—É."

    # –ó–∞–º–µ–Ω—è–µ–º –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é (–∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç)
    if re.search(r"<b>6\. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:</b>[\s\S]*?(?=<b>|$)", answer):
        answer = re.sub(
            r"<b>6\. –°–≤—è–∑–∞–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã:</b>[\s\S]*?(?=<b>|$)",
            related_block + "\n",
            answer,
        )
    else:
        answer += "\n\n" + related_block

    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    def sort_docs(m):
        docs = m.group(1).strip().splitlines()
        docs = sorted(set(docs), key=lambda x: re.sub(r'\D', '', x))
        return "<b>3. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è:</b>\n" + "\n".join(docs) + "\n"

    answer = re.sub(
        r"<b>3\. –î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è:</b>\n([\s\S]*?)(?=<b>|$)",
        sort_docs,
        answer,
    )

    bad_phrases = [
        "–ø–æ –∑–∞–∫–æ–Ω—É", "–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É", "–ø–æ –ø—Ä–∞–≤–∏–ª–∞–º",
        "–æ–±—ã—á–Ω–æ", "–º–æ–∂–Ω–æ", "–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ", "—á–∞—â–µ –≤—Å–µ–≥–æ",
        "–æ–∑–Ω–∞—á–∞–µ—Ç", "–≤ —Å–ª—É—á–∞–µ", "–µ—Å–ª–∏"
    ]
    for phrase in bad_phrases:
        if phrase in answer.lower():
            logger.warning(f"‚ùó –ù–∞–π–¥–µ–Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è —Ñ—Ä–∞–∑–∞ –≤ –æ—Ç–≤–µ—Ç–µ: {phrase}")

    return answer.strip()
   

def check_completeness(q, punkts, answer):
    cited_nums = set(re.findall(r"–ø\. ?(\d+)", answer))
    missed = []
    for p in punkts:
        if p["punkt_num"] and p["punkt_num"] not in cited_nums:
            missed.append(p["punkt_num"])
    if missed:
        logger.warning(f"‚ùó –ù–µ –æ—Ç—Ä–∞–∂–µ–Ω—ã –ø—É–Ω–∫—Ç—ã: {missed} –≤ –æ—Ç–≤–µ—Ç–µ –Ω–∞: {q}")

async def start(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –ü—Ä–∞–≤–∏–ª–∞–º –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏ –ø–µ–¥–∞–≥–æ–≥–æ–≤.",
        parse_mode="HTML"
    )

def build_human_friendly(q, punkts, official_answer):
    if re.search(r"–ø–ª–∞—Ç–Ω|–æ–ø–ª–∞—Ç|—Å—Ç–æ–∏–º–æ—Å—Ç|–ø–ª–∞—Ç–Ω–æ|—Å—Ç–æ–∏–º–æ—Å—Ç—å", q, re.I):
        if "–ø. 41" in official_answer or "41" in official_answer:
            return (
                "–ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ –≤ –≥–æ–¥, "
                "–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ ‚Äî –Ω–∞ –ø–ª–∞—Ç–Ω–æ–π –æ—Å–Ω–æ–≤–µ —Å–æ–≥–ª–∞—Å–Ω–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π —Å—É–º–º–µ (–ø. 41). "
                "–î–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –ü—Ä–æ–±–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –Ω–∞ –ø–ª–∞—Ç–Ω–æ–π –æ—Å–Ω–æ–≤–µ (–ø. 41)."
            )
    # --- –î–∞–ª–µ–µ –æ—Å–Ω–æ–≤–Ω–æ–π prompt (–∫–∞–∫ –æ–ø–∏—Å–∞–Ω–æ –≤—ã—à–µ)
    prompt = (
    f"–í–æ–ø—Ä–æ—Å: {q}\n"
    "–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∏–∂–µ. "
    "–í –æ—Ç–≤–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –Ω–æ–º–µ—Ä –ø—É–Ω–∫—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ (–ø. X). "
    "–ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–µ–ª–∞—Ç—å –ª—é–±—ã–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã, —É–ø—Ä–æ—â–µ–Ω–∏—è, —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è, –ø–æ—è—Å–Ω–µ–Ω–∏—è –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏. "
    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞, –±—ã—Ç–æ–≤—ã–µ –æ–±–æ—Ä–æ—Ç—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ ¬´–º–æ–∂–Ω–æ¬ª, ¬´–æ–±—ã—á–Ω–æ¬ª, ¬´–µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å¬ª –∏ –¥—Ä. "
    "–¢–æ–ª—å–∫–æ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω—ã–µ, –∫—Ä–∞—Ç–∫–∏–µ –∏ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã. "
    "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞—Ç–Ω–æ—Å—Ç–∏ ‚Äî —á–µ—Ç–∫–æ —É–∫–∞–∂–∏: –∫—Ç–æ, –∫–æ–≥–¥–∞ –∏ –Ω–∞ –∫–∞–∫–∏—Ö –æ—Å–Ω–æ–≤–∞–Ω–∏—è—Ö –ø–ª–∞—Ç–∏—Ç, —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø—É–Ω–∫—Ç. "
    "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ü–µ–¥—É—Ä–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ—à–∞–≥–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –ø–æ –ü—Ä–∞–≤–∏–ª–∞–º, —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø—É–Ω–∫—Ç—ã. "
    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ ¬´–ø–æ –∑–∞–∫–æ–Ω—É¬ª, ¬´–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É¬ª, ¬´–ø–æ –ø—Ä–∞–≤–∏–ª–∞–º¬ª ‚Äî —Ç–æ–ª—å–∫–æ —Ü–∏—Ç–∞—Ç—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏ –ø—É–Ω–∫—Ç–æ–≤. "
    "–ï—Å–ª–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –æ—Ç–≤–µ—Ç—å: ¬´–í –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–∞–ø—Ä—è–º—É—é –æ—Ç–≤–µ—á–∞—é—â–∞—è –Ω–∞ –¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å.¬ª\n\n"
    f"–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:\n{official_answer}\n\n"
    "–ö—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:"
)
    

    try:
        response = openai.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.15,
            max_tokens=180,
        )
        return response.choices[0].message.content.strip()
    except Exception as e:
        print("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ human-friendly –æ—Ç–≤–µ—Ç–∞:", e)
        return "(–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ)"

def filter_related_punkts(q, all_punkts, cited_nums):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª—å–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å –≤–æ–ø—Ä–æ—Å–æ–º (–ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º),
    –∏ –Ω–µ –±—ã–ª–∏ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–æ—Å–ª–æ–≤–Ω–æ —Ä–∞–Ω–µ–µ.
    """
    q_lower = q.lower()
    # –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å
    themes = {
        # –ü–µ–Ω—Å–∏—è, –≤–æ–∑—Ä–∞—Å—Ç, –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
        "–ø–µ–Ω—Å–∏": r"–ø–µ–Ω—Å–∏|–ø–µ–Ω—Å–∏–æ–Ω|–≤–æ–∑—Ä–∞—Å—Ç|–æ—Å–≤–æ–±–æ–∂–¥[–µ—ë]–Ω|–≤—ã—Ö–æ–¥ –Ω–∞ –ø–µ–Ω—Å–∏|—Å—Ç–∞—Ä—à–µ|–≤–æ–∑—Ä–∞—Å—Ç–Ω|–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä|–¥–æ —Å–∫–æ–ª—å–∫–∏ –ª–µ—Ç",
        # –î–µ–∫—Ä–µ—Ç, –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å, —É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω–∫–æ–º
        "–¥–µ–∫—Ä–µ—Ç": r"–¥–µ–∫—Ä–µ—Ç|–±–µ—Ä–µ–º–µ–Ω|—É—Ö–æ–¥ –∑–∞ —Ä–µ–±–µ–Ω|–æ—Ç–ø—É—Å–∫ –ø–æ —É—Ö–æ–¥|–º–∞—Ç–µ—Ä–∏–Ω—Å—Ç–≤|—Ä–æ–¥–æ–≤|–Ω–µ—Ç—Ä—É–¥–æ—Å–ø–æ—Å–æ–±–Ω",
        # –ë–æ–ª–∞—à–∞–∫, –∑–∞—Ä—É–±–µ–∂–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞, Nazarbayev University
        "–±–æ–ª–∞—à–∞–∫": r"–±–æ–ª–∞—à–∞|nazarbayev|phd|–º–∞–≥–∏—Å—Ç—Ä|–∑–∞—Ä—É–±–µ–∂–Ω|–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω|–≤—É–∑|—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
        # –°—Ç–∞–∂–µ—Ä, –ø–µ—Ä–≤–∏—á–Ω–∞—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –≤–ø–µ—Ä–≤—ã–µ
        "—Å—Ç–∞–∂–µ—Ä": r"—Å—Ç–∞–∂–µ—Ä|—Å—Ç–∞–∂—ë—Ä|–ø–µ—Ä–≤–∏—á–Ω|–ø–µ—Ä–≤—ã–π —Ä–∞–∑|–≤–ø–µ—Ä–≤—ã–µ|–Ω–∞—á–∞–ª|—Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª|—Å—Ç–∞–∂ —Ä–∞–±–æ—Ç—ã|–ø–æ—Å–ª–µ –≥–æ–¥–∞|–ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≥–æ–¥–∞",
        # –ù–∞—Ä—É—à–µ–Ω–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞, —Å–∞–Ω–∫—Ü–∏–∏
        "–Ω–∞—Ä—É—à": r"–Ω–∞—Ä—É—à|—Å–∞–Ω–∫—Ü|–∞–∫—Ç|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|–∞–Ω–Ω—É–ª–∏—Ä|–¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä|–æ—Ç–∫–∞–∑|–¥–∏—Å–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|–Ω–∞–∫–∞–∑–∞–Ω|–æ—Ç—Å—Ç—Ä–∞–Ω|—Ñ–∞–ª—å—Å–∏—Ñ–∏–∫–∞—Ü|–Ω–µ–¥–æ—Å—Ç–æ–≤–µ—Ä–Ω|–ª–∏—à–µ–Ω|–ø–æ–Ω–∏–∂–µ–Ω|–æ–±–Ω–∞—Ä—É–∂–µ–Ω|–Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω",
        # –ê–ø–µ–ª–ª—è—Ü–∏–∏, –∂–∞–ª–æ–±—ã, –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏–µ, —Å–ø–æ—Ä—ã, –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ, –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏
        "–∂–∞–ª–æ–±": r"–∂–∞–ª–æ–±|–∞–ø–µ–ª–ª—è—Ü|–æ–±–∂–∞–ª|–ø—Ä–µ—Ç–µ–Ω–∑|—Å–ø–æ—Ä–Ω|–æ—Å–ø–æ—Ä|–Ω–µ—Å–æ–≥–ª–∞—Å|–ø–µ—Ä–µ—Å–º–æ—Ç—Ä|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω|–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è|–ø—Ä–µ—Ç–µ–Ω–∑–∏—è",
        # –ü–æ—Ä—Ç–∞–ª, –ø–æ–¥–∞—á–∞ —á–µ—Ä–µ–∑ eGov, —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –∑–∞—è–≤–ª–µ–Ω–∏–µ
        "–ø–æ—Ä—Ç–∞–ª": r"–ø–æ—Ä—Ç–∞–ª|egov|—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ|–≤–µ–±-–ø–æ—Ä—Ç–∞–ª|–ø–æ–¥–∞—á–∞|–∑–∞—è–≤–∫|–∑–∞—è–≤–ª–µ–Ω–∏|—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü|–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç|–æ–Ω–ª–∞–π–Ω",
        # –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        "–∫–∞—Ç–µ–≥–æ—Ä": r"–∫–∞—Ç–µ–≥–æ—Ä|–ø—Ä–∏—Å–≤–æ–µ–Ω|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω|–ø—Ä–∏—Å–≤–æ–µ–Ω–∏|–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏|–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü|–ø—Ä–∏—Å–≤–æ–∏—Ç—å|–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å|–ø–æ–≤—ã—à–µ–Ω–∏|–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏",
        # –ê—Ç—Ç–µ—Å—Ç–∞—Ü–∏—è, –ø–æ—Ä—è–¥–æ–∫, —Å—Ä–æ–∫–∏, —ç—Ç–∞–ø—ã
        "–∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏": r"–∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏|–ø—Ä–æ—Ü–µ–¥—É—Ä|–ø–æ—Ä—è–¥–æ–∫|—ç—Ç–∞–ø|—Å—Ä–æ–∫|–ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏|–ø–æ–≤—Ç–æ—Ä–Ω|–≤–Ω–µ–æ—á–µ—Ä–µ–¥–Ω|–¥–æ—Å—Ä–æ—á–Ω|—É—Å–∫–æ—Ä–µ–Ω|–Ω–µ–º–µ–¥–ª–µ–Ω–Ω|–Ω–µ–æ—Ç–ª–æ–∂–Ω",
        # –î–æ–∫—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ñ–æ—Ä–º—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, –ª–∏—Å—Ç—ã, –≤—ã–ø–∏—Å–∫–∏, –ø—Ä–∏–∫–∞–∑—ã, –∑–∞–∫–ª—é—á–µ–Ω–∏—è
        "–¥–æ–∫—É–º–µ–Ω—Ç": r"–¥–æ–∫—É–º–µ–Ω—Ç|—Ñ–æ—Ä–º–∞|–ø—Ä–∏–ª–æ–∂–µ–Ω|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏|—Ä–µ—à–µ–Ω–∏|–ø—Ä–æ—Ç–æ–∫–æ–ª|–ø—Ä–∏–∫–∞–∑|–ª–∏—Å—Ç|–≤—ã–ø–∏—Å–∫–∞|–∑–∞–∫–ª—é—á–µ–Ω–∏|–∞–∫—Ç|–∑–∞—è–≤–ª–µ–Ω–∏–µ|—Å–ø—Ä–∞–≤–∫–∞",
        # –û—Ç—Å—Ä–æ—á–∫–∞, –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –ø–µ—Ä–µ–Ω–æ—Å, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –ø—Ä–æ–¥–ª–µ–Ω–∏–µ, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –±–æ–ª–µ–∑–Ω–∏, –≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±–∞
        "–æ—Ç—Å—Ä–æ—á–∫–∞": r"–æ—Ç—Å—Ä–æ—á–∫|–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤|–ø—Ä–æ–¥–ª–µ–Ω|–ø–µ—Ä–µ–Ω–æ—Å|—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ—Å–≤–æ–±–æ–∂–¥|–∏—Å–∫–ª—é—á–µ–Ω|–ø–µ—Ä–µ—Ä—ã–≤|–ø—Ä–µ–∫—Ä–∞—â–µ–Ω|–ø–∞—É–∑–∞|—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–≤–æ–∏–Ω—Å–∫–∞—è —Å–ª—É–∂–±|–±–æ–ª–µ–∑–Ω",
        # –ö–æ–º–∏—Å—Å–∏—è, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, —Ä–µ—à–µ–Ω–∏–µ, –∑–∞—Å–µ–¥–∞–Ω–∏–µ, —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏
        "–∫–æ–º–∏—Å—Å–∏": r"–∫–æ–º–∏—Å—Å–∏|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω|–Ω–∞–∑–Ω–∞—á–µ–Ω|–Ω–∞–∑–Ω–∞—á–µ–Ω–∏|—Ä–µ—à–µ–Ω–∏|–∑–∞—Å–µ–¥–∞–Ω–∏–µ|—Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∫–æ–º–∏—Å—Å–∏–∏|—á–ª–µ–Ω—ã –∫–æ–º–∏—Å—Å–∏–∏",
        # –°—Ç–∞–∂–∏—Ä–æ–≤–∫–∞, –∏—Å–ø—ã—Ç–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ä–æ–∫, –æ–±—É—á–µ–Ω–∏–µ, –æ–±—É—á–µ–Ω–∏–µ –∑–∞ —Ä—É–±–µ–∂–æ–º
        "—Å—Ç–∞–∂–∏—Ä–æ–≤–∫–∞": r"—Å—Ç–∞–∂–∏—Ä–æ–≤–∫|–∏—Å–ø—ã—Ç–∞—Ç–µ–ª—å–Ω|–æ–±—É—á–µ–Ω–∏|–ø—Ä–∞–∫—Ç–∏–∫–∞|–ø—Ä–∞–∫—Ç–∏–∫–∞–Ω—Ç|–∏–Ω—Ç–µ—Ä–Ω–∞—Ç—É—Ä|–ø–æ–≤—ã—à–µ–Ω–∏[–µ—è] –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏",
    }

    matched_themes = [rx for key, rx in themes.items() if re.search(rx, q_lower, re.I)]
    if not matched_themes:
        return []
    related = []
    for p in all_punkts:
        # –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –ø—Ä–æ—Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
        if p["punkt_num"] in cited_nums:
            continue
        if any(re.search(rx, p["text"], re.I) for rx in matched_themes):
            related.append(p)
    return related

async def handle(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    q = update.message.text or ""
    user = update.effective_user

    logger.info("‚á¢ %s", q)
    punkts = merge_bullets(rag_search(q))[:45]
    logger.info("–ù–∞—à–ª–∏ –ø—É–Ω–∫—Ç–æ–≤: %d", len(punkts))

    # –ü–æ–ª—É—á–∞–µ–º –æ–±–∞ –æ—Ç–≤–µ—Ç–∞
    official_answer = ask_llm(q, punkts) if punkts else "–ü—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
    official_answer = postprocess_answer(q, punkts, official_answer)
    human_friendly = build_human_friendly(q, punkts, official_answer)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (user.id)
    LAST_QA[user.id] = (q, punkts, human_friendly, official_answer)

    # –§–æ—Ä–º–∏—Ä—É–µ–º human-friendly —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
    reply_text = (
        f"üí° <b>–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:</b>\n{human_friendly}\n\n"
        f"<i>–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.</i>"
    )
    keyboard = [
        [InlineKeyboardButton("–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç", callback_data="show_official")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        fix_unclosed_tags(reply_text),
        parse_mode="HTML",
        reply_markup=reply_markup
    )

    # –õ–æ–≥–∏—Ä—É–µ–º human-friendly –æ—Ç–≤–µ—Ç (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–Ω–æ–ø–∫–∏)
    timestamp = datetime.datetime.now().isoformat(sep=' ', timespec='seconds')
    log_to_sheet(
        user_id=user.id if user else "",
        username=user.username if user and user.username else "",
        message=q,
        bot_answer=human_friendly,
        timestamp=timestamp
    )
async def button(update: Update, ctx: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    await query.answer()

    if query.data == "show_official":
        qa = LAST_QA.get(user.id)
        if qa:
            q, punkts, human_friendly, official_answer = qa
            reply_text = f"<b>–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ –ü—Ä–∞–≤–∏–ª–∞–º:</b>\n{official_answer}"

            await query.message.reply_text(
                fix_unclosed_tags(reply_text),
                parse_mode="HTML"
            )

            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            import datetime
            timestamp = datetime.datetime.now().isoformat(sep=' ', timespec='seconds')
            log_to_sheet(
                user_id=user.id if user else "",
                username=user.username if user and user.username else "",
                message=f"[–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞] {q}",
                bot_answer=official_answer,
                timestamp=timestamp
            )
        else:
            await query.message.reply_text("–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")


# ---- –ù–∏–∂–µ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ webhook ----

TOKEN = os.environ.get("TELEGRAM_TOKEN")
PORT = int(os.environ.get("PORT", "8080"))  # Render –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç PORT=10000 –∏–ª–∏ 8080
WEBHOOK_PATH = f"/{TOKEN}"
WEBHOOK_URL = os.environ.get("WEBHOOK_URL") 


# ----- —Ç–≤–æ–π –≥–ª–æ–±–∞–ª—å–Ω—ã–π LAST_QA, –∞ —Ç–∞–∫–∂–µ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ —Ä–∞–Ω—å—à–µ -----

# (–û—Å—Ç–∞–≤—å —Å–≤–æ–∏ handle, button, start ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!)

# ---- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∏ aiohttp —Å–µ—Ä–≤–µ—Ä–∞ ----

async def on_startup(app):
    await app['bot'].bot.set_webhook(url=WEBHOOK_URL + WEBHOOK_PATH)
    logger.info("Webhook set to %s", WEBHOOK_URL + WEBHOOK_PATH)

async def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle))
    app.add_handler(CallbackQueryHandler(button))
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ webhook.")
    await app.initialize()
    # –°–æ–∑–¥–∞–µ–º aiohttp –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Telegram
    web_app = web.Application()
    web_app['bot'] = app

    # endpoint –¥–ª—è Telegram webhook
    async def handle_update(request):
        data = await request.json()
        update = Update.de_json(data, app.bot)
        await app.process_update(update)
        return web.Response(text="ok")
    web_app.router.add_post(WEBHOOK_PATH, handle_update)
    web_app.on_startup.append(on_startup)

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—Ç—É
    runner = web.AppRunner(web_app)
    await runner.setup()
    site = web.TCPSite(runner, "0.0.0.0", PORT)
    await site.start()

    # –ù–µ –¥–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—É —É–º–µ—Ä–µ—Ç—å
    while True:
        await asyncio.sleep(3600)
if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
