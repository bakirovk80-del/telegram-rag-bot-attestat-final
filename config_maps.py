
# -*- coding: utf-8 -*-
"""
config_maps.py — универсальные триггеры для RAG
Назначение: по ключевым фразам в пользовательском вопросе «подсветить» релевантные пункты Правил.
Важно: номера пунктов ниже — под текущую редакцию ваших Правил (по переписке подтверждены p.5, p.32, p.41, p.45, p.13, а также упоминались p.6, p.38, p.40).
Если у вас иная редакция — скорректируйте номера в словарях ниже (сохраните структуру).

Как это работает в боте:
- webhook_main.py импортирует UNIVERSAL_MAP
- при совпадении ключевой фразы (ключ словаря) с вопросом пользователя —
  в кандидаты добавляется соответствующий пункт (punkt_num/subpunkt_num).

Правило именования ключей:
- Всегда lower-case. Бот приводит запрос к lower и ищет вхождение подстроки.
- Старайтесь делать ключи максимально «узкими», если это исключение (например, по программе «Болашақ»),
  и более «широкими» — для общих норм (например, иностранное обучение → п.5.1).

Рекомендуемая стратегия пополнения:
- Сначала добавляйте ключи в соответствующий тематический словарь (см. ниже),
- затем они будут автоматически собраны в UNIVERSAL_MAP.
"""

# ───────────────────────── БАЗОВЫЕ НОРМЫ / КАТЕГОРИИ ─────────────────────────

# Кто подлежит аттестации, общая норма (подпункты п.5 могут отличаться; здесь 5.1)
COMPETENCY_MAP = {
    "кто проходит аттестацию":       {"punkt_num": "5", "subpunkt_num": "1"},
    "подлежит аттестации":           {"punkt_num": "5", "subpunkt_num": "1"},
    "прохождение аттестации":        {"punkt_num": "5", "subpunkt_num": "1"},
    "педагог имеет образование":     {"punkt_num": "5", "subpunkt_num": "1"},
    "профессиональное образование":  {"punkt_num": "5", "subpunkt_num": "1"},
}

# Периодичность/общий порядок (в переписке упоминался п.6)
PERIODICITY_MAP = {
    "периодичность аттестации":      {"punkt_num": "6", "subpunkt_num": ""},
    "раз в пять лет":                {"punkt_num": "6", "subpunkt_num": ""},
    "не реже одного раза в пять":    {"punkt_num": "6", "subpunkt_num": ""},
}

# ───────────────────── ИНОСТРАННОЕ ОБУЧЕНИЕ / ЗАРУБЕЖ ────────────────────────

# Общая норма про обучение/стажировку за пределами РК → п.5.1 (нет автоматического освобождения)
FOREIGN_STUDY_MAP = {
    "магистратура за рубежом":                   {"punkt_num": "5", "subpunkt_num": "1"},
    "зарубежная магистратура":                   {"punkt_num": "5", "subpunkt_num": "1"},
    "иностранная магистратура":                  {"punkt_num": "5", "subpunkt_num": "1"},
    "за рубежом":                                {"punkt_num": "5", "subpunkt_num": "1"},
    "за рубеж":                                  {"punkt_num": "5", "subpunkt_num": "1"},
    "за границей":                               {"punkt_num": "5", "subpunkt_num": "1"},
    "зарубеж":                                   {"punkt_num": "5", "subpunkt_num": "1"},
    "зарубежом":                                 {"punkt_num": "5", "subpunkt_num": "1"},  # частая опечатка
    "за пределами рк":                           {"punkt_num": "5", "subpunkt_num": "1"},
    "за пределами республики казахстан":         {"punkt_num": "5", "subpunkt_num": "1"},
    "обучении за пределами":                     {"punkt_num": "5", "subpunkt_num": "1"},
    "стажировке за пределами":                   {"punkt_num": "5", "subpunkt_num": "1"},
    "из стран ближнего и дальнего зарубежья":    {"punkt_num": "5", "subpunkt_num": "1"},
    "прибыл из зарубежья":                       {"punkt_num": "5", "subpunkt_num": "1"},
    "выпускник зарубежного вуза":                {"punkt_num": "5", "subpunkt_num": "1"},
    "иностранный диплом":                        {"punkt_num": "5", "subpunkt_num": "1"},
}


# Спец-исключение «Болашақ», NU и перечень рекомендованных организаций → п.32
BOLASHAQ_MAP = {
    "болашақ":                                   {"punkt_num": "32", "subpunkt_num": ""},
    "bolashak":                                  {"punkt_num": "32", "subpunkt_num": ""},
    "болашак":                                   {"punkt_num": "32", "subpunkt_num": ""},
    "nazarbayev university":                     {"punkt_num": "32", "subpunkt_num": ""},
    "выпускник nazarbayev university":           {"punkt_num": "32", "subpunkt_num": ""},
    "зарубежных организаций высшего":            {"punkt_num": "32", "subpunkt_num": ""},
    "перечень рекомендованных":                  {"punkt_num": "32", "subpunkt_num": ""},
    "список рекомендованных по программе":       {"punkt_num": "32", "subpunkt_num": ""},
    "без прохождения процедуры аттестации":      {"punkt_num": "32", "subpunkt_num": ""},
    "квалификационная категория педагог-модератор": {"punkt_num": "32", "subpunkt_num": ""},
}

# ───────────────────── НАЗНАЧЕНИЕ БЕЗ АТТЕСТАЦИИ / ФАСТ-ТРЕК ──────────────────

# Специальные случаи присвоения категории без аттестации
FASTTRACK_MAP = {
    # Присвоение без аттестации (конкретные условия обычно в п.32 и/или других пунктах)
    "без аттестации присваивается":  {"punkt_num": "32", "subpunkt_num": ""},
    "присваивается без аттестации":  {"punkt_num": "32", "subpunkt_num": ""},
    # Педагог-стажёр (упоминался п.6 — при необходимости скорректируйте по вашей редакции)
    "педагог-стажер":                {"punkt_num": "6", "subpunkt_num": ""},
    "педагог стажер":                {"punkt_num": "6", "subpunkt_num": ""},
}

# Явные формулировки «освобождается от аттестации» → сводим к п.32 + п.6 (уточнит LLM)
EXEMPTION_MAP = {
    "освобождается от аттестации":   {"punkt_num": "32", "subpunkt_num": ""},
    "без прохождения аттестации":    {"punkt_num": "32", "subpunkt_num": ""},
}

# ───────────────────────── ДОКУМЕНТЫ / ПОДАЧА / СРОКИ ─────────────────────────

# Перечень документов, подача заявления — ранее указывался п.13
DOCS_MAP = {
    "какие документы":               {"punkt_num": "13", "subpunkt_num": ""},
    "перечень документов":           {"punkt_num": "13", "subpunkt_num": ""},
    "заявление по форме":            {"punkt_num": "13", "subpunkt_num": ""},
    "заявление на прохождение оценки знаний": {"punkt_num": "13", "subpunkt_num": ""},
    "приложение 2":                  {"punkt_num": "13", "subpunkt_num": ""},
}

# Этапы/порядок процедуры, регистрация, сроки подачи (уточняйте по своей редакции)
PROCEDURE_MAP = {
    "порядок процедуры":             {"punkt_num": "13", "subpunkt_num": ""},
    "сроки подачи":                  {"punkt_num": "13", "subpunkt_num": ""},
    "подача документов":             {"punkt_num": "13", "subpunkt_num": ""},
    "регистрация на оценку знаний":  {"punkt_num": "13", "subpunkt_num": ""},
}

# ───────────────────────── ТЕСТИРОВАНИЕ / ОЗП ────────────────────────────────

# Блок про Оценку знаний (число вопросов, порог, структура) — скорректируйте p.29/p.30 по вашей версии
EXAM_MAP = {
    "оценка знаний педагогов":       {"punkt_num": "29", "subpunkt_num": ""},
    "тестирование":                  {"punkt_num": "29", "subpunkt_num": ""},
    "количество вопросов":           {"punkt_num": "29", "subpunkt_num": ""},
    "порог прохождения":             {"punkt_num": "30", "subpunkt_num": ""},
    "результаты тестирования":       {"punkt_num": "30", "subpunkt_num": ""},
    "пересдача":                     {"punkt_num": "30", "subpunkt_num": ""},
}

# ───────────────────────── АПЕЛЛЯЦИИ / КОМИССИИ ──────────────────────────────

APPEAL_RESP_MAP = {
    "апелляция":                     {"punkt_num": "40", "subpunkt_num": ""},
    "порядок апелляции":             {"punkt_num": "40", "subpunkt_num": ""},
    "апелляционная комиссия":        {"punkt_num": "38", "subpunkt_num": ""},
    "комиссия":                      {"punkt_num": "38", "subpunkt_num": ""},
    "протокол комиссии":             {"punkt_num": "38", "subpunkt_num": ""},
}

# ───────────────────────── НАРУШЕНИЯ / АННУЛИРОВАНИЕ ─────────────────────────

VIOLATIONS_MAP = {
    "нарушение процедуры":           {"punkt_num": "45", "subpunkt_num": ""},
    "аннулирование результатов":     {"punkt_num": "45", "subpunkt_num": ""},
    "аннулируется аттестация":       {"punkt_num": "45", "subpunkt_num": ""},
    "списывание":                    {"punkt_num": "45", "subpunkt_num": ""},
    "использование телефона":        {"punkt_num": "45", "subpunkt_num": ""},
}

# ───────────────────────── ОПЛАТА / ПЛАТНОСТЬ ────────────────────────────────

PAYMENT_MAP = {
    "платно":                        {"punkt_num": "41", "subpunkt_num": ""},
    "оплата":                        {"punkt_num": "41", "subpunkt_num": ""},
    "взнос":                         {"punkt_num": "41", "subpunkt_num": ""},
    "госпошлина":                    {"punkt_num": "41", "subpunkt_num": ""},
    "стоимость":                     {"punkt_num": "41", "subpunkt_num": ""},
    "возврат оплаты":                {"punkt_num": "41", "subpunkt_num": ""},
}

# ───────────────────────── ПРОЧЕЕ / ЧАСТЫЕ СЛУЧАИ ────────────────────────────

MISC_MAP = {
    "повышение квалификации":        {"punkt_num": "5", "subpunkt_num": "1"},
    # Не форсим льготу: общее упоминание «квалификационная категория» → к общим нормам п.5.1
    "квалификационная категория":    {"punkt_num": "5", "subpunkt_num": "1"},
    # «присвоение категории» логичнее вести к процедуре
    "присвоение категории":          {"punkt_num": "10", "subpunkt_num": ""},
    # Явные просьбы про льготы — остаются на п.32
    "льготы по аттестации":          {"punkt_num": "32", "subpunkt_num": ""},
    "освобождение от аттестации":    {"punkt_num": "32", "subpunkt_num": ""},
}


# ───────────────────────── ПЕНСИОНЕРЫ / ПЕНСИОННЫЙ ВОЗРАСТ ─────────────────────────
# П.30 — освобождение, если до пенсии ≤ 4 лет; п.57 — порядок для работающих пенсионеров.
RETIREMENT_MAP = {
    "работающий пенсионер":               {"punkt_num": "57", "subpunkt_num": ""},
    "пенсионер":                          {"punkt_num": "57", "subpunkt_num": ""},
    "пенсионного возраста":               {"punkt_num": "57", "subpunkt_num": ""},

    "до пенсии":                          {"punkt_num": "30", "subpunkt_num": ""},
    "осталось до пенсии":                 {"punkt_num": "30", "subpunkt_num": ""},
    "за 4 года до пенсии":                {"punkt_num": "30", "subpunkt_num": ""},
    "за четыре года до пенсии":           {"punkt_num": "30", "subpunkt_num": ""},
    "4 года до пенсии":                   {"punkt_num": "30", "subpunkt_num": ""},
    "четыре года до пенсии":              {"punkt_num": "30", "subpunkt_num": ""},
}

# ───────────────────────── СБОРКА ЕДИНОГО СЛОВАРЯ ────────────────────────────
UNIVERSAL_MAP: dict[str, dict[str, str]] = {}
for _map in (
    COMPETENCY_MAP,
    PERIODICITY_MAP,
    FOREIGN_STUDY_MAP,
    BOLASHAQ_MAP,
    FASTTRACK_MAP,
    EXEMPTION_MAP,
    DOCS_MAP,
    PROCEDURE_MAP,
    EXAM_MAP,
    APPEAL_RESP_MAP,
    VIOLATIONS_MAP,
    PAYMENT_MAP,
    MISC_MAP,
    RETIREMENT_MAP,  # ← обязательно добавить
):
    UNIVERSAL_MAP.update(_map)

if __name__ == "__main__":
    print(f"Всего триггеров: {len(UNIVERSAL_MAP)}")
    tests = [
        "если я работающий пенсионер надо ли мне сдавать аттестацию",
        "для тех кто закончил магистратуру зарубежом нужно ли сдавать аттестацию",
        "как присваивается квалификационная категория педагог-мастер",
    ]
    for q in tests:
        hits = [(k, UNIVERSAL_MAP[k]) for k in UNIVERSAL_MAP if k in q]
        print("Q:", q)
        print("→ Совпавшие ключи:", hits)

